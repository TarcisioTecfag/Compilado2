<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cat√°logo de M√°quinas para Automa√ß√£o Industrial</title>
  <style>
    :root {
      color-scheme: dark;
      --bg-dark: #020204;
      --bg-panel: #09090f;
      --bg-panel-secondary: #12060b;
      --bg-card: #18121c;
      --accent: linear-gradient(130deg, #ff124f, #ff512f);
      --accent-2: #ff6f61;
      --accent-strong: #ff1e56;
      --accent-soft: rgba(255, 56, 92, 0.35);
      --accent-color-1: #ff124f;
      --accent-color-2: #ff512f;
      --text-primary: #f5f5f7;
      --text-secondary: #a3a3b1;
      --border: rgba(255, 255, 255, 0.08);
      --shadow: 0 30px 80px rgba(0, 0, 0, 0.65);
      --radius-xl: 36px;
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(255, 56, 92, 0.12), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(255, 18, 79, 0.1), transparent 20%),
                  var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 0 24px 56px;
    }

    header.topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      margin: 0 auto;
      left: 24px;
      right: 24px;
      background: var(--bg-panel);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 14px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      backdrop-filter: blur(10px);
    }

    .topbar-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .topbar-nav {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      overflow: hidden;
      padding-bottom: 0;
    }

    .topbar-nav::-webkit-scrollbar {
      display: none;
    }

    .brand-btn {
      background: var(--accent);
      color: #0f0c10;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      font-weight: 800;
      letter-spacing: 0.4px;
      cursor: pointer;
      text-transform: uppercase;
      box-shadow: 0 12px 30px rgba(255, 18, 79, 0.35);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      white-space: nowrap;
    }

    .brand-btn:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 14px 36px rgba(255, 18, 79, 0.45);
    }

    .nav-pill {
      border: 1px solid var(--accent-soft);
      background: rgba(18, 12, 20, 0.85);
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 0.4px;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border 0.2s ease;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .nav-pill:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 10px 28px rgba(255, 18, 79, 0.35);
      border-color: rgba(255, 111, 97, 0.6);
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .icon-btn {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--bg-panel-secondary);
      color: var(--text-primary);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border 0.2s ease;
      position: relative;
    }

    .icon-btn:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
      border-color: var(--accent-soft);
    }

    .badge-count {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--accent);
      color: #0f0c10;
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 0.7rem;
      border: 1px solid rgba(0, 0, 0, 0.35);
    }

    .badge-count.hidden {
      display: none;
    }

    .topbar-search {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .search-box {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 320px;
    }

    .search-box input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #130f15;
      color: var(--text-primary);
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .search-box input:focus {
      border-color: var(--accent-color-1);
      box-shadow: 0 0 0 3px rgba(255, 18, 79, 0.15);
    }

    .badge {
      padding: 8px 14px;
      border-radius: 12px;
      background: linear-gradient(120deg, rgba(255, 18, 79, 0.16), rgba(255, 81, 47, 0.12));
      color: var(--accent-2);
      border: 1px solid rgba(255, 18, 79, 0.35);
      font-weight: 600;
      letter-spacing: 0.4px;
      white-space: nowrap;
    }

    main {
      max-width: 1400px;
      margin: 24px auto;
    }

    .catalog-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 18px;
    }

    .card {
      background: linear-gradient(160deg, rgba(24, 18, 28, 0.9), rgba(16, 12, 18, 0.95));
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(229, 57, 53, 0.08), transparent 30%);
      pointer-events: none;
    }

    .card img {
      width: 100%;
      aspect-ratio: 1 / 1;
      max-width: 200px;
      align-self: center;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    .card h3 {
      margin: 0;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .price {
      color: var(--accent-2);
      font-weight: 700;
      font-size: 1.05rem;
    }

    .chip {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(229, 57, 53, 0.12);
      border: 1px solid rgba(229, 57, 53, 0.35);
      color: var(--text-primary);
    }

    .card-actions {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }

    button:not(.brand-btn):not(.nav-pill):not(.icon-btn):not(.tag-toggle),
    label.upload-label {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-primary);
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-transform: none;
      box-shadow: none;
    }

    .card-actions button,
    .card-actions label.upload-label,
    .card-actions .tag-select {
      width: 100%;
    }

    button:not(.brand-btn):not(.nav-pill):not(.icon-btn):not(.tag-toggle):hover,
    label.upload-label:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.45);
      border-color: rgba(255, 111, 97, 0.55);
    }

    button.secondary,
    label.secondary {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.14);
      box-shadow: none;
      text-transform: none;
      font-weight: 700;
    }

    .upload-input {
      display: none;
    }

    .tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tag-manager {
      margin: 18px auto 8px;
      max-width: 1400px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(18, 12, 20, 0.85), rgba(12, 9, 13, 0.95));
      box-shadow: var(--shadow);
    }

    .tag-manager-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .tag-manager-title {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .tag-toggle {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-panel-secondary);
      color: var(--text-primary);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border 0.2s ease;
    }

    .tag-toggle:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
      border-color: var(--accent-soft);
    }

    .tag-manager-content.collapsed {
      display: none;
    }

    .tag-manager h2 {
      margin: 0;
      font-size: 1rem;
      color: var(--text-primary);
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    .tag-form {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }

    .tag-form input {
      flex: 1;
      min-width: 200px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #130f15;
      color: var(--text-primary);
      outline: none;
    }

    .tag-form input:focus {
      border-color: var(--accent-color-1);
      box-shadow: 0 0 0 3px rgba(255, 18, 79, 0.15);
    }

    .tag-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .tag-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(18, 12, 20, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.06);
      gap: 10px;
    }

    .tag-name {
      font-weight: 700;
      color: var(--text-primary);
    }

    .tag-actions {
      display: flex;
      gap: 8px;
    }

    .tag-select {
      flex: 1;
      width: 100%;
      min-width: 120px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #130f15;
      color: var(--text-primary);
    }

    .tag-controls {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
      margin-top: 2px;
      flex-wrap: wrap;
    }

    .chip.removable {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip.removable button {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0 4px;
      border-radius: 6px;
    }

    .chip.removable button:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      border: 1px dashed var(--border);
      border-radius: 16px;
      background: rgba(24, 18, 28, 0.5);
    }

    .detail-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 20;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .detail-modal.active {
      opacity: 1;
      pointer-events: all;
    }

    .detail-card {
      background: #120d14;
      max-width: 1120px;
      width: 100%;
      border-radius: 22px;
      border: 1px solid var(--border);
      padding: 24px;
      box-shadow: 0 28px 80px rgba(0, 0, 0, 0.6);
    }

    .detail-content {
      display: grid;
      grid-template-columns: 1.45fr 0.9fr;
      gap: 18px;
      align-items: start;
    }

    .detail-header {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 16px;
      align-items: center;
      margin-bottom: 14px;
    }

    .detail-gallery {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .detail-main-image {
      width: 100%;
      max-width: 260px;
      height: 260px;
      object-fit: cover;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }

    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(64px, 1fr));
      gap: 8px;
      max-width: 260px;
    }

    .thumbnail {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      object-fit: cover;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.02);
    }

    .thumbnail.active {
      border-color: var(--accent-color-1);
      box-shadow: 0 0 0 2px rgba(255, 18, 79, 0.25);
    }

    .detail-body {
      color: var(--text-secondary);
      line-height: 1.65;
      max-width: 740px;
    }

    .observations {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
    }

    .observations label {
      font-weight: 700;
      color: var(--text-primary);
    }

    .observations textarea {
      width: 100%;
      min-height: 110px;
      padding: 14px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #130f15;
      color: var(--text-primary);
      resize: vertical;
      outline: none;
    }

    .observations textarea:focus {
      border-color: var(--accent-color-1);
      box-shadow: 0 0 0 3px rgba(255, 18, 79, 0.15);
    }

    .video-block {
      margin: 12px 0 4px;
      display: grid;
      gap: 8px;
      width: 100%;
    }

    .detail-sidebar .video-block {
      margin-top: 0;
    }

    .video-block h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .video-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #0f0c10;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }

    .video-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    .video-placeholder {
      width: 100%;
      height: 100%;
      position: relative;
      display: grid;
      place-items: center;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      border: none;
      padding: 0;
      color: var(--text-primary);
    }

    .video-placeholder::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.55));
    }

    .play-badge {
      position: relative;
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 10px 28px rgba(255, 18, 79, 0.45);
      display: grid;
      place-items: center;
      font-size: 26px;
      font-weight: 800;
      color: #0f0c10;
      z-index: 1;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .video-placeholder:hover .play-badge,
    .video-placeholder:focus-visible .play-badge {
      transform: scale(1.05);
      box-shadow: 0 12px 36px rgba(255, 18, 79, 0.6);
      outline: none;
    }

    .detail-sidebar {
      background: linear-gradient(180deg, rgba(24, 18, 28, 0.75), rgba(12, 10, 14, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .detail-sidebar h3 {
      margin: 0;
      font-size: 0.95rem;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--text-primary);
    }

    .sidebar-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .detail-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 16px;
      flex-wrap: wrap;
    }

    .detail-footer button {
      min-width: 150px;
    }

    @media (max-width: 1024px) {
      .detail-content {
        grid-template-columns: 1fr;
      }

      .detail-header {
        grid-template-columns: 1fr;
      }

      .detail-main-image {
        max-width: 100%;
        height: 260px;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 0 16px 32px;
      }

      .topbar-row {
        flex-wrap: wrap;
        gap: 10px;
      }

      .topbar-nav {
        width: 100%;
      }

      .actions {
        width: 100%;
        justify-content: flex-start;
      }

      .topbar-search .search-box {
        min-width: 0;
      }

      .card {
        padding: 14px;
      }

      .detail-header {
        grid-template-columns: 1fr;
        align-items: flex-start;
      }

      .detail-gallery {
        flex-direction: row;
        align-items: center;
      }

      .detail-main-image {
        width: 100%;
        height: auto;
        max-width: 320px;
      }
    }

    @media (max-width: 1200px) {
      .catalog-grid {
        grid-template-columns: repeat(5, minmax(0, 1fr));
      }
    }

    @media (max-width: 992px) {
      .catalog-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      .catalog-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 520px) {
      .catalog-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }
  </style>
</head>
  <body>
    <header class="topbar">
      <div class="topbar-row">
        <div class="topbar-left">
          <button class="brand-btn" type="button">ASSISTENTE TECFAG</button>
          <nav class="topbar-nav" aria-label="Atalhos">
            <button class="nav-pill" type="button">Mapas Mentais</button>
            <button class="nav-pill" type="button">Cat√°logos</button>
            <button class="nav-pill" type="button">Din√¢micas</button>
          </nav>
        </div>
        <div class="actions">
          <button id="notification-button" class="icon-btn" title="Notifica√ß√µes">
            <span>üîî</span>
            <span id="notification-badge" class="badge-count hidden">0</span>
          </button>
          <button id="reload-button" class="icon-btn" title="Recarregar">üîÅ</button>
          <button id="profile-button" class="icon-btn" title="Abrir navega√ß√£o">üë§</button>
        </div>
      </div>
      <div class="topbar-search">
        <div class="search-box">
          <input id="searchInput" type="search" placeholder="Buscar por nome da m√°quina..." aria-label="Buscar produtos" />
          <span class="badge" id="resultCount"></span>
        </div>
      </div>
    </header>

    <section class="tag-manager" aria-labelledby="tagManagerTitle">
      <div class="tag-manager-header">
        <div class="tag-manager-title">
          <button id="tagToggle" class="tag-toggle" type="button" aria-expanded="true" aria-controls="tagManagerContent">‚åÉ</button>
          <h2 id="tagManagerTitle">Gerenciar tags</h2>
        </div>
        <div class="tag-form" id="tagFormRow">
          <input id="tagInput" type="text" placeholder="Criar ou editar uma tag" aria-label="Campo para nova tag" />
          <button id="saveTagButton" type="button">Salvar tag</button>
          <button id="cancelEditButton" class="secondary" type="button" hidden>Cancelar</button>
        </div>
      </div>
      <div id="tagManagerContent" class="tag-manager-content">
        <div id="tagList" class="tag-list" aria-live="polite"></div>
      </div>
    </section>

  <main>
    <div class="catalog-grid" id="catalogGrid"></div>
    <div class="empty-state" id="emptyState" hidden>Nenhum produto encontrado para este filtro.</div>
  </main>

  <div class="detail-modal" id="detailModal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
    <div class="detail-card">
      <div class="detail-content">
        <div class="detail-main">
          <div class="detail-header">
            <div class="detail-gallery">
              <img id="detailImage" class="detail-main-image" alt="Imagem detalhada do produto">
              <div id="thumbnailGrid" class="thumbnail-grid"></div>
            </div>
            <div>
              <h2 id="detailTitle"></h2>
              <p class="price" id="detailPrice"></p>
              <div class="tags" id="detailTags"></div>
            </div>
          </div>
          <div class="detail-body" id="detailDescription"></div>
          <div class="observations">
            <label for="detailObservations">Observa√ß√µes</label>
            <textarea id="detailObservations" placeholder="Digite observa√ß√µes sobre o produto"></textarea>
          </div>
        </div>
        <aside class="detail-sidebar" aria-label="Painel do item">
          <h3>Gerenciar item</h3>
          <div class="video-block" aria-label="V√≠deo do produto">
            <h3>V√≠deo demonstrativo</h3>
            <div id="videoFrame" class="video-frame"></div>
          </div>
          <div class="sidebar-group">
            <div class="tag-controls">
              <select id="detailTagSelect" class="tag-select">
                <option value="">Adicionar tag existente</option>
              </select>
              <button id="detailAddTag" type="button">Adicionar tag</button>
            </div>
            <label class="upload-label secondary">
              Carregar imagens (at√© 4)
              <input id="detailUpload" type="file" accept="image/*" class="upload-input" multiple />
            </label>
          </div>
        </aside>
      </div>
      <div class="detail-footer">
        <button id="downloadDocs" type="button">Baixar documentos</button>
        <button class="secondary" id="closeModal">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const catalogGrid = document.getElementById('catalogGrid');
    const searchInput = document.getElementById('searchInput');
    const emptyState = document.getElementById('emptyState');
    const resultCount = document.getElementById('resultCount');
    const tagInput = document.getElementById('tagInput');
    const tagListEl = document.getElementById('tagList');
    const saveTagButton = document.getElementById('saveTagButton');
    const cancelEditButton = document.getElementById('cancelEditButton');
    const tagManagerContent = document.getElementById('tagManagerContent');
    const tagToggle = document.getElementById('tagToggle');
    const tagFormRow = document.getElementById('tagFormRow');

    const toggleTagPanel = () => {
      const collapsed = tagManagerContent.classList.toggle('collapsed');
      tagFormRow.hidden = collapsed;
      tagToggle.setAttribute('aria-expanded', (!collapsed).toString());
      tagToggle.textContent = collapsed ? '‚åÑ' : '‚åÉ';
    };

    tagToggle.addEventListener('click', toggleTagPanel);

    const placeholderImage =
      "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='400' viewBox='0 0 400 400'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%23e53935' stop-opacity='0.4'/><stop offset='100%' stop-color='%230f0c10' stop-opacity='0.9'/></linearGradient></defs><rect width='400' height='400' fill='%2318121c'/><rect x='12' y='12' width='376' height='376' rx='26' fill='url(%23g)' stroke='%232a1d2d' stroke-width='4'/><text x='50%' y='50%' text-anchor='middle' dominant-baseline='middle' fill='%23c7c7c7' font-family='Inter,Arial,sans-serif' font-size='22'>Imagem n√£o carregada</text></svg>";

    const youtubeVideoId = 'tT1BIkdLKJk';
    const youtubeEmbedUrl = `https://www.youtube.com/embed/${youtubeVideoId}?autoplay=1&rel=0`;
    const youtubePoster = `https://img.youtube.com/vi/${youtubeVideoId}/hqdefault.jpg`;

    const detailModal = document.getElementById('detailModal');
    const detailImage = document.getElementById('detailImage');
    const thumbnailGrid = document.getElementById('thumbnailGrid');
    const detailTitle = document.getElementById('detailTitle');
    const detailPrice = document.getElementById('detailPrice');
    const detailTags = document.getElementById('detailTags');
    const detailDescription = document.getElementById('detailDescription');
    const videoFrame = document.getElementById('videoFrame');
    const detailObservations = document.getElementById('detailObservations');
    const closeModal = document.getElementById('closeModal');
    const detailTagSelect = document.getElementById('detailTagSelect');
    const detailAddTag = document.getElementById('detailAddTag');
    const detailUpload = document.getElementById('detailUpload');
    const downloadDocs = document.getElementById('downloadDocs');
    let editingTag = null;
    let currentDetailProduct = null;

    const normalizeText = (text = '') =>
      text
        .toString()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');

    const buildContext = (parts = []) => normalizeText(parts.filter(Boolean).join(' | ')).replace(/[|]/g, ' ');

    const TAG_RULES = [
      { tag: 'P√≥s', keywords: [' pos ', ' pos-', ' pos/', 'pos ', ' pos'] },
      { tag: 'Granulados', keywords: ['granulado', 'granulados'] },
      { tag: 'Gr√£os', keywords: ['graos', 'grao'] },
      { tag: 'Gr√£os e Farelos', keywords: ['graos e farelos', 'grao e farelo', 'farelos'] },
      { tag: 'Filme Stretch', keywords: ['stretch'] },
      { tag: 'Fita de Arquear', keywords: ['fita de arquear', 'arqueadora', 'arquear'] },
      {
        tag: 'Grupo A (R√≥tulos/Pap√©is/Embalagens)',
        test: (ctx) =>
          ctx.includes('rotulos/papeis/embalagens') &&
          !ctx.includes('sacos de papel') &&
          !ctx.includes('pequenas caixas') &&
          !ctx.includes('esteira'),
      },
      {
        tag: 'Grupo B (R√≥tulos/Pap√©is/Embalagens/sacos de papel ou de pl√°stico/ pequenas caixas)',
        test: (ctx) =>
          ctx.includes('rotulos/papeis/embalagens') &&
          (ctx.includes('sacos de papel') || ctx.includes('pequenas caixas')),
      },
      {
        tag: 'Grupo C (A√ßo/Ferro/Madeira/Vidro/Concreto/Pl√°stico/Papel)',
        keywords: ['aco ferro madeira vidro concreto plastico papel'],
      },
      { tag: 'Fita Gomada', keywords: ['fita gomada'] },
      { tag: 'C√°psulas', keywords: ['capsula', 'capsulas'] },
      { tag: 'C√°psulas Envasadora', test: (ctx) => ctx.includes('capsula') && ctx.includes('envasador') },
      { tag: 'Softgel', keywords: ['softgel'] },
      { tag: 'Comprimidos', keywords: ['comprimido', 'comprimidos'] },
      { tag: 'L√≠quido', keywords: ['liquido'] },
      { tag: 'Pastoso', keywords: ['pastoso'] },
      { tag: 'Grupo D (Frascos, Latas, Outros)', keywords: ['frascos latas outros'] },
      { tag: 'Caixas', keywords: ['caixa', 'caixas'] },
      {
        tag: 'Grupo E (R√≥tulos/Pap√©is/Embalagens)',
        test: (ctx) => ctx.includes('rotulos/papeis/embalagens') && ctx.includes('esteira'),
      },
      { tag: 'Caixa de Papel√£o', keywords: ['caixa de papelao', 'caixas de papelao'] },
      { tag: 'Embalagens Pl√°sticas', keywords: ['embalagens plasticas', 'embalagem plastica'] },
      { tag: 'P√≥s secos', keywords: ['pos seco', 'pos secos'] },
      { tag: 'Gr√¢nulos secos', keywords: ['granulos secos', 'granulo seco'] },
      { tag: 'Tampas Bico de Pato', keywords: ['bico de pato'] },
      { tag: 'Tampas de Metal', keywords: ['tampas de metal', 'tampa de metal'] },
      { tag: 'Tampas de Pl√°sticos', keywords: ['tampas de plast', 'tampa plast'] },
      { tag: 'R√≥tulos', keywords: ['rotulo', 'rotulos'] },
      { tag: 'R√≥tulos Lacres', keywords: ['lacres'] },
      { tag: 'Filme', keywords: [' filme', 'filme '] },
      { tag: 'Filme Aliment√≠cio', keywords: ['filme alimenticio', 'pelicula'] },
      { tag: 'Fita acr√≠lica', keywords: ['fita acrilica'] },
      { tag: 'Fita Hot Melt', keywords: ['hot melt'] },
      { tag: 'Sacos', keywords: ['saco ', 'sacos'] },
      { tag: 'BOPP', keywords: ['bopp'] },
      { tag: 'PP', keywords: ['polipropileno', ' pp ', 'pp ('] },
      { tag: 'PE', keywords: ['polietileno', ' pe ', 'pe ('] },
      { tag: 'PVC', keywords: ['pvc'] },
      { tag: 'POF', keywords: ['pof'] },
      { tag: 'PET', keywords: [' pet ', 'pet/'] },
      { tag: 'OPS', keywords: ['ops'] },
      { tag: 'Filme Termoencolh√≠vel', keywords: ['filme termoencolhivel', 'termoencolhivel'] },
      { tag: 'Bandeja', keywords: ['bandeja'] },
      {
        tag: 'Grupo A (PA+PE (Poliamida/Nilon + Polietileno) / EVOH / PET+PE / PE, PET , PP)',
        keywords: ['poliamida', 'evoh', 'pa+pe'],
      },
      {
        tag: 'Folha de alum√≠nio (ponto de fus√£o: 100-200 ¬∞C)',
        keywords: ['folha de aluminio', 'ponto de fusao: 100-200'],
      },
      { tag: 'Pl√°stico Termoencolh√≠vel', keywords: ['plastico termoencolhivel'] },
      { tag: 'Blister', keywords: ['blister'] },
      { tag: 'Alum√≠nio-Plastico', keywords: ['aluminio-plastico', 'aluminio plastico'] },
      { tag: 'Alum√≠nio-Alum√≠nio', keywords: ['aluminio-aluminio', 'aluminio aluminio'] },
      { tag: 'Sleeve termoencolh√≠vel', keywords: ['sleeve'] },
      {
        tag: 'Grupo A (BOPP, PET, PE, OUTROS)',
        keywords: ['bopp, pet, pe, outros', 'bopp, pet, pe'],
      },
      {
        tag: 'Grupo B (PET/CPP, PET, PE, OPP/CPP, EVOH, Folha de alum√≠nio e outros filmes)',
        keywords: ['pet/cpp', 'opp/cpp', 'outros filmes'],
      },
      { tag: 'Tinta s√≥lida', keywords: ['tinta solida'] },
      { tag: 'Inkjet', keywords: ['inkjet'] },
      { tag: 'Fita Ribbon', keywords: ['fita ribbon'] },
    ];

    const deriveTags = (parts = []) => {
      const context = buildContext(parts);
      const tags = new Set();

      const hasSemiauto = context.includes('semiautomat');
      const hasManual = context.includes('manual');
      const hasAuto = context.includes('automat');

      if (hasSemiauto) tags.add('Semiautom√°tica');
      if (hasManual) tags.add('Manual');
      if (hasAuto && !hasSemiauto) tags.add('Autom√°tica');

      TAG_RULES.forEach((rule) => {
        const normalizedKeywords = rule.keywords?.map((kw) => normalizeText(kw.trim()));
        const matched = rule.test
          ? rule.test(context)
          : normalizedKeywords?.some((kw) => context.includes(kw));
        if (matched) {
          tags.add(rule.tag);
        }
      });

      return Array.from(tags);
    };

    const slugify = (text = 'documento') =>
      normalizeText(text)
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '') || 'documento';

    const products = [
      {
        id: 1,
        title: 'PAGINADORA ROTATIVA EM ACO INOX',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQIPAU007 - PAGINADORA ROTATIVA EM ACO INOX | Tipo de Produto: R√≥tulos/Pap√©is/Embalagens | Di√¢metro do produto (mm): - | Largura do produto (mm): 50-300 | Altura do produto (mm): - | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 1500 | Velocidade: 0‚Äî50 m/min | √Årea de Corte (mm): 430 | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 2,
        title: 'ALIMENTADOR ELEVADOR DE CANECAS P/ EMPACOTADORAS',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQGPAU055 - ALIMENTADOR ELEVADOR DE CANECAS P/ EMPACOTADORAS | Tipo de Produto: Gr√£os | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): - | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 2100 | Velocidade: Volume de Transporte: 18000 litros/h | √Årea de Corte (mm): - | Altura do Elevador (mm): 1900 | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 3,
        title: 'BC1.5M/200S ESTEIRA FIXA LONA ACO INOX C/ CONTR. VEL. - 150CMX25CMX75CM',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESAU004 - BC1.5M/200S ESTEIRA FIXA LONA ACO INOX C/ CONTR. VEL. - 150CMX25CMX75CM | Tipo de Produto: Frascos, Latas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): 190 | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 1500 | Velocidade: 9-30 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 4,
        title: 'BC1M/W300P ESTEIRA TRASP. EM LONA 1M X 30CM LARG. C/ CONTROL. VELOC.',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMN012 - BC1M/W300P ESTEIRA TRASP. EM LONA 1M X 30CM LARG. C/ CONTROL. VELOC. | Tipo de Produto: Frascos, Latas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): 190 | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 1000 | Velocidade: 30 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 5,
        title: 'BC2.5M/300S ESTEIRA TRASP. INOX EM LONA 2,5M X 30CM LARG. C/ CONTROL. VELOC.',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMN016 - BC2.5M/300S ESTEIRA TRASP. INOX EM LONA 2,5M X 30CM LARG. C/ CONTROL. VELOC. | Tipo de Produto: Frascos, Latas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): 190 | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 1000 | Velocidade: 30 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 6,
        title: 'BC2.5M/W300P - ESTEIRA TRASP. EM LONA C2,5M X L30CM C/ CONTROL. VELOC.',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMN020 - BC2.5M/W300P - ESTEIRA TRASP. EM LONA C2,5M X L30CM C/ CONTROL. VELOC. | Tipo de Produto: Frascos, Latas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): 190 | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 2500 | Velocidade: 30 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 7,
        title: 'BC2.5M/W500P - ESTEIRA TRASP. EM LONA C2,5M X L50CM C/ CONTROL. VELOC.',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMN022 - BC2.5M/W500P - ESTEIRA TRASP. EM LONA C2,5M X L50CM C/ CONTROL. VELOC. | Tipo de Produto: Frascos, Latas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 2500 | Velocidade: 30 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 8,
        title: 'BC2.5M/W500S -  ESTEIRA TRASP. INOX  LONA C2,5M X L50CM/ACO INOX/CONTROL. VELOC.',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMN013 - BC2.5M/W500S -  ESTEIRA TRASP. INOX  LONA C2,5M X L50CM/ACO INOX/CONTROL. VELOC. | Tipo de Produto: Frascos, Latas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 2500 | Velocidade: 30 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 9,
        title: 'BTT1000 - MESA ACUMULADORA GIRATORIA 1000MM',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESAU005 - BTT1000 - MESA ACUMULADORA GIRATORIA 1000MM | Tipo de Produto: Frascos | Di√¢metro do produto (mm): √ò20-100 | Largura do produto (mm): - | Altura do produto (mm): 20-150 | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 1000 | Velocidade: 0-10 rota√ß√µes/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 10,
        title: 'ESTEIRA TRANSPORTADORA 1M C/ CONTROLE DE VELOC. P/ AUTOM.',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMA006 - ESTEIRA TRANSPORTADORA 1M C/ CONTROLE DE VELOC. P/ AUTOM. | Tipo de Produto: Frascos, Latas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 1000 | Velocidade: - | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 11,
        title: 'RC1M/D ESTEIRA TRANSPORTADORA COM ROLETES MOTORIZADA',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMA004 - RC1M/D ESTEIRA TRANSPORTADORA COM ROLETES MOTORIZADA | Tipo de Produto: Caixas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): 480 | Largura dos Gomos (mm): - | Comprimento (mm): 1000 | Velocidade: 15 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 12,
        title: 'RC1M/DP ESTEIRA TRANSPORTADORA DE ROLETES',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMA007 - RC1M/DP ESTEIRA TRANSPORTADORA DE ROLETES  | Tipo de Produto: Caixas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 1000 | Velocidade: 15 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 13,
        title: 'RC1M-ESTEIRA DE ROLETES LIVRES 1 M',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMA002 - RC1M-ESTEIRA DE ROLETES LIVRES 1 M | Tipo de Produto: Caixas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): 480 | Largura dos Gomos (mm): - | Comprimento (mm): 1000 | Velocidade: 15 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 14,
        title: 'RC2M/D-ESTEIRA TRANSPORTE DE CAIXA COM MOTOR(220V)',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESAU001 - RC2M/D-ESTEIRA TRANSPORTE DE CAIXA COM MOTOR(220V) | Tipo de Produto: Caixas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): 480 | Largura dos Gomos (mm): - | Comprimento (mm): 2000 | Velocidade: 15 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 15,
        title: 'RC2M-ESTEIRA TRANSPORTE DE CAIXA',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQESMA003 - RC2M-ESTEIRA TRANSPORTE DE CAIXA | Tipo de Produto: Caixas, Outros | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): Ilimitado | Largura da Lona (mm): - | Largura do Rolete (mm): 480 | Largura dos Gomos (mm): - | Comprimento (mm): 2000 | Velocidade: 15 m/min | √Årea de Corte (mm): - | Altura do Elevador (mm): - | Tipo de M√°quina: Autom√°tica.'
      },
      {
        id: 16,
        title: 'ZC7200- ALIMENTADOR ELEVADOR DE PRODUTOS TIPO "Z"',
        price: 'Sob consulta',
        tags: [],
        description:
          'PAMQSLSA077 - ZC7200- ALIMENTADOR ELEVADOR DE PRODUTOS TIPO "Z"  | Tipo de Produto: Gr√£os | Di√¢metro do produto (mm): - | Largura do produto (mm): - | Altura do produto (mm): - | Largura da Lona (mm): - | Largura do Rolete (mm): - | Largura dos Gomos (mm): - | Comprimento (mm): 3500 | Velocidade: Volume de Transporte: 4000-7200 litros/h | √Årea de Corte (mm): - | Altura do Elevador (mm): 3200 | Tipo de M√°quina: Autom√°tica.'
      }
    ];

    const loadExternalDataset = async () => {
      try {
        const response = await fetch('data/catalog-dataset.json');
        if (!response.ok) return;
        const datasetText = await response.text();
        const dataset = JSON.parse(datasetText);
        let nextId = products.length + 1;

        dataset.forEach((sheet) => {
          const rows = sheet.dados || [];
          if (rows.length < 3) return;
          const headers = rows[1] || {};
          const keys = Object.keys(headers);
          if (keys.length < 2) return;

          for (let i = 2; i < rows.length; i += 1) {
            const row = rows[i];
            const code = row?.[keys[0]];
            const name = row?.[keys[1]];
            if (!code || !name) continue;

            const details = [];
            for (let j = 2; j < keys.length; j += 1) {
              const label = headers[keys[j]] || keys[j];
              let value = row?.[keys[j]];
              if (value === null || value === undefined || value === '') value = '-';
              details.push(`${label}: ${value}`);
            }

            products.push({
              id: nextId++,
              title: String(name).trim(),
              price: 'Sob consulta',
              description: `${code} - ${name} | ${details.join(' | ')}`,
              tags: deriveTags([sheet.planilha, code, name, ...details]),
              observacoes: ''
            });
          }
        });
      } catch (error) {
        console.error('Erro ao carregar dataset externo', error);
      }
    };

    const productImages = new Map();

    const getImages = (id) => productImages.get(id) || [];
    const setImages = (id, images = []) => productImages.set(id, images.slice(0, 4));
    const resolveImage = (id) => getImages(id)[0] || placeholderImage;
    let availableTags = [];
    let currentKeyword = '';

    const renderTagList = () => {
      tagListEl.innerHTML = '';
      availableTags.forEach((tag) => {
        const row = document.createElement('div');
        row.className = 'tag-row';

        const name = document.createElement('span');
        name.className = 'tag-name';
        name.textContent = tag;
        row.appendChild(name);

        const actions = document.createElement('div');
        actions.className = 'tag-actions';

        const editButton = document.createElement('button');
        editButton.className = 'secondary';
        editButton.type = 'button';
        editButton.textContent = 'Editar';
        editButton.addEventListener('click', () => {
          editingTag = tag;
          tagInput.value = tag;
          saveTagButton.textContent = 'Salvar edi√ß√£o';
          cancelEditButton.hidden = false;
        });

        const deleteButton = document.createElement('button');
        deleteButton.className = 'secondary';
        deleteButton.type = 'button';
        deleteButton.textContent = 'Excluir';
        deleteButton.addEventListener('click', () => {
          availableTags = availableTags.filter((item) => item !== tag);
          products.forEach((product) => {
            product.tags = product.tags.filter((t) => t !== tag);
          });
          applyFilter();
          renderTagList();
          if (currentDetailProduct) {
            refreshDetailTagSelect();
            refreshDetailTags(currentDetailProduct);
          }
        });

        actions.appendChild(editButton);
        actions.appendChild(deleteButton);
        row.appendChild(actions);
        tagListEl.appendChild(row);
      });
    };

    const resetTagForm = () => {
      editingTag = null;
      tagInput.value = '';
      saveTagButton.textContent = 'Salvar tag';
      cancelEditButton.hidden = true;
    };

    const upsertTag = () => {
      const value = tagInput.value.trim();
      if (!value) return;

      const exists = availableTags.some((tag) => tag.toLowerCase() === value.toLowerCase());

      if (editingTag) {
        const normalizedEditing = editingTag.toLowerCase();
        availableTags = availableTags.map((tag) => (tag.toLowerCase() === normalizedEditing ? value : tag));
        products.forEach((product) => {
          product.tags = product.tags.map((tag) => (tag.toLowerCase() === normalizedEditing ? value : tag));
        });
      } else if (!exists) {
        availableTags.push(value);
      }

      resetTagForm();
      renderTagList();
      applyFilter();
      if (currentDetailProduct) {
        refreshDetailTagSelect();
        refreshDetailTags(currentDetailProduct);
      }
    };

    saveTagButton.addEventListener('click', upsertTag);
    cancelEditButton.addEventListener('click', resetTagForm);

    const renderProducts = (items) => {
      catalogGrid.innerHTML = '';

      if (!items.length) {
        emptyState.hidden = false;
        resultCount.textContent = '0 resultados';
        return;
      }

      emptyState.hidden = true;
      resultCount.textContent = `${items.length} resultado${items.length === 1 ? '' : 's'}`;

      items.forEach((product) => {
        const card = document.createElement('article');
        card.className = 'card';

        const img = document.createElement('img');
        img.src = resolveImage(product.id);
        img.alt = product.title;
        card.appendChild(img);

        const title = document.createElement('h3');
        title.textContent = product.title;
        card.appendChild(title);

        const price = document.createElement('div');
        price.className = 'price';
        price.textContent = product.price;
        card.appendChild(price);

        const actions = document.createElement('div');
        actions.className = 'card-actions';

        const detailBtn = document.createElement('button');
        detailBtn.textContent = 'Ver detalhes';
        detailBtn.addEventListener('click', () => openDetails(product));
        actions.appendChild(detailBtn);

        card.appendChild(actions);
        catalogGrid.appendChild(card);
      });
    };

    const refreshDetailTagSelect = () => {
      detailTagSelect.innerHTML = '';
      const placeholderOption = document.createElement('option');
      placeholderOption.value = '';
      placeholderOption.textContent = 'Adicionar tag existente';
      detailTagSelect.appendChild(placeholderOption);
      availableTags.forEach((tag) => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        detailTagSelect.appendChild(option);
      });
    };

    const refreshDetailTags = (product) => {
      detailTags.innerHTML = '';
      product.tags.forEach((tag) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = tag;
        detailTags.appendChild(chip);
      });
    };

    const refreshGallery = (product) => {
      const images = getImages(product.id);
      let activeIndex = Number(detailImage.dataset.activeIndex || 0);
      if (!images[activeIndex]) activeIndex = 0;
      detailImage.dataset.activeIndex = activeIndex;
      detailImage.src = images[activeIndex] || placeholderImage;

      thumbnailGrid.innerHTML = '';

      if (!images.length) {
        const empty = document.createElement('span');
        empty.className = 'chip';
        empty.textContent = 'Sem imagens';
        thumbnailGrid.appendChild(empty);
        return;
      }

      images.forEach((src, index) => {
        const thumb = document.createElement('img');
        thumb.src = src;
        thumb.alt = `${product.title} miniatura ${index + 1}`;
        thumb.className = 'thumbnail';
        if (index === activeIndex) thumb.classList.add('active');
        thumb.addEventListener('click', () => {
          detailImage.dataset.activeIndex = index;
          detailImage.src = src;
          thumbnailGrid.querySelectorAll('.thumbnail').forEach((node, i) => {
            node.classList.toggle('active', i === index);
          });
        });
        thumbnailGrid.appendChild(thumb);
      });
    };

    const refreshDetailIfOpen = (product) => {
      if (currentDetailProduct && currentDetailProduct.id === product.id) {
        refreshDetailTags(currentDetailProduct);
        refreshDetailTagSelect();
        refreshGallery(product);
      }
    };

    const startVideoPlayback = () => {
      if (!videoFrame) return;
      videoFrame.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = youtubeEmbedUrl;
      iframe.title = 'V√≠deo demonstrativo do produto';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      videoFrame.appendChild(iframe);
    };

    const renderVideoPlaceholder = () => {
      if (!videoFrame) return;
      videoFrame.innerHTML = '';
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'video-placeholder';
      button.style.backgroundImage = `url('${youtubePoster}')`;
      button.setAttribute('aria-label', 'Reproduzir v√≠deo demonstrativo no YouTube');

      const play = document.createElement('div');
      play.className = 'play-badge';
      play.textContent = '‚ñ∂';
      button.appendChild(play);

      const start = () => startVideoPlayback();
      button.addEventListener('click', start);
      button.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          start();
        }
      });

      videoFrame.appendChild(button);
    };

    const openDetails = (product) => {
      currentDetailProduct = product;
      detailTitle.textContent = product.title;
      detailPrice.textContent = product.price;
      refreshDetailTags(product);
      refreshDetailTagSelect();
      detailTagSelect.value = '';
      detailDescription.textContent = product.description;
      detailObservations.value = product.observacoes || '';
      refreshGallery(product);
      renderVideoPlaceholder();
      detailModal.classList.add('active');
    };

    const closeDetails = () => {
      detailModal.classList.remove('active');
      if (videoFrame) videoFrame.innerHTML = '';
      currentDetailProduct = null;
    };

    detailModal.addEventListener('click', (event) => {
      if (event.target === detailModal) {
        closeDetails();
      }
    });
    closeModal.addEventListener('click', closeDetails);

    detailAddTag.addEventListener('click', () => {
      if (!currentDetailProduct) return;
      const selected = detailTagSelect.value;
      if (!selected) return;
      if (!currentDetailProduct.tags.includes(selected)) {
        currentDetailProduct.tags.push(selected);
        refreshDetailTags(currentDetailProduct);
        applyFilter();
      }
      detailTagSelect.value = '';
    });

    detailObservations.addEventListener('input', (event) => {
      if (!currentDetailProduct) return;
      currentDetailProduct.observacoes = event.target.value;
    });

    detailUpload.addEventListener('change', (event) => {
      if (!currentDetailProduct) return;
      const files = Array.from(event.target.files || []);
      if (!files.length) return;

      const existing = getImages(currentDetailProduct.id);
      const remaining = Math.max(0, 4 - existing.length);
      if (!remaining) return;

      const additions = files.slice(0, remaining).map((file) => URL.createObjectURL(file));
      setImages(currentDetailProduct.id, [...existing, ...additions]);
      refreshGallery(currentDetailProduct);
      applyFilter();
      event.target.value = '';
    });

    downloadDocs.addEventListener('click', () => {
      if (!currentDetailProduct) return;
      const images = getImages(currentDetailProduct.id);
      if (!images.length) return;

      images.forEach((src, index) => {
        const link = document.createElement('a');
        link.href = src;
        link.download = `${slugify(currentDetailProduct.title)}-imagem-${index + 1}.png`;
        document.body.appendChild(link);
        link.click();
        link.remove();
      });
    });

    const applyFilter = () => {
      const normalized = currentKeyword.trim().toLowerCase();
      const filtered = products.filter((product) => product.title.toLowerCase().includes(normalized));
      renderProducts(filtered);
    };

    searchInput.addEventListener('input', (event) => {
      currentKeyword = event.target.value;
      applyFilter();
    });

    const initializeCatalog = async () => {
      await loadExternalDataset();
      products.forEach((product) => {
        if (!product.observacoes) product.observacoes = '';
        if (!productImages.has(product.id)) setImages(product.id, getImages(product.id));
        product.tags = deriveTags([product.title, product.description]);
      });
      availableTags = Array.from(new Set(products.flatMap((product) => product.tags))).sort();
      renderTagList();
      applyFilter();
    };

    initializeCatalog();
  </script>
</body>
</html>
